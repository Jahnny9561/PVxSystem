// src/server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Site {
  site_id      Int           @id @default(autoincrement())
  name         String?       @db.VarChar(255)
  location     String?       @db.VarChar(255)
  capacity_kw  Decimal?      @db.Decimal(10, 2)
  timezone     String?       @db.VarChar(255)
  
  // Relations
  groups       PvGroup[]
  weatherData  WeatherData[]
  userSites    UserSite[]

  @@map("site")
}

model PvGroup {
  group_id         Int       @id @default(autoincrement())
  site_id          Int?
  orientation      String?   @db.VarChar(255)
  tilt_angle_deg   Decimal?  @db.Decimal(5, 2)
  nominal_power_kw Decimal?  @db.Decimal(10, 2)

  // Relations
  site      Site?      @relation(fields: [site_id], references: [site_id])
  panels    PvPanel[]
  inverters Inverter[]
  sensors   Sensor[]

  @@map("pv_group")
}

model PvPanel {
  panel_id          Int      @id @default(autoincrement())
  group_id          Int?
  manufacturer      String?  @db.VarChar(255)
  model             String?  @db.VarChar(255)
  rated_power_w     Decimal? @db.Decimal(10, 2)
  voltage_nominal_v Decimal? @db.Decimal(10, 2)
  serial_number     String?  @db.VarChar(255)

  // Relations
  group PvGroup? @relation(fields: [group_id], references: [group_id])

  @@map("pv_panel")
}

// The Central Device Table (Master list for simulation/telemetry)
model Device {
  device_id    Int     @id @default(autoincrement())
  type         String? @db.VarChar(255) // e.g., "INVERTER", "SENSOR"
  reference_id Int?    // The ID of the specific sensor/inverter table
  name         String? @db.VarChar(255)
  manufacturer String? @db.VarChar(255)
  model        String? @db.VarChar(255)

  // Relations
  telemetry      Telemetry[]
  eventLogs      EventLog[]
  controlCommands ControlCommand[]

  @@map("device")
}

model Inverter {
  inverter_id    Int      @id @default(autoincrement())
  group_id       Int?
  rated_power_kw Decimal? @db.Decimal(10, 2)
  ip_address     String?  @db.VarChar(255)

  // Relations
  group PvGroup? @relation(fields: [group_id], references: [group_id])

  @@map("inverter")
}

model Sensor {
  sensor_id Int     @id @default(autoincrement())
  group_id  Int?
  type      String? @db.VarChar(255) 
  unit      String? @db.VarChar(255)
  location  String? @db.VarChar(255)

  // Relations
  group PvGroup? @relation(fields: [group_id], references: [group_id])

  @@map("sensor")
}

model Telemetry {
  telemetry_id BigInt   @id @default(autoincrement())
  device_type  String?  @db.VarChar(255)
  device_id    Int?     // Links to Device.device_id
  timestamp    DateTime @default(now())
  parameter    String?  @db.VarChar(255) // e.g., "Power", "Voltage"
  value        Decimal? @db.Decimal(10, 4)
  unit         String?  @db.VarChar(255)

  // Relations
  device Device? @relation(fields: [device_id], references: [device_id])

  @@index([device_id, timestamp]) // Important for chart speed
  @@map("telemetry")
}

model WeatherData {
  weather_id     BigInt   @id @default(autoincrement())
  site_id        Int?
  timestamp      DateTime @default(now())
  irradiance_wm2 Decimal? @db.Decimal(10, 2)
  ambient_temp_c Decimal? @db.Decimal(5, 2)
  module_temp_c  Decimal? @db.Decimal(5, 2)
  wind_speed_ms  Decimal? @db.Decimal(5, 2)
  wind_dir_deg   Decimal? @db.Decimal(5, 2)

  // Relations
  site Site? @relation(fields: [site_id], references: [site_id])

  @@map("weather_data")
}

model EventLog {
  event_id     BigInt   @id @default(autoincrement())
  timestamp    DateTime @default(now())
  device_type  String?  @db.VarChar(255)
  device_id    Int?
  severity     String?  @db.VarChar(255) 
  message      String?  @db.Text
  acknowledged Boolean  @default(false)

  // Relations
  device Device? @relation(fields: [device_id], references: [device_id])

  @@map("event_log")
}

model ControlCommand {
  command_id       BigInt   @id @default(autoincrement())
  device_id        Int?
  user_id          Int?
  timestamp        DateTime @default(now())
  command          String?  @db.VarChar(255)
  status           String?  @db.VarChar(255) 
  response_message String?  @db.Text

  // Relations
  device Device?      @relation(fields: [device_id], references: [device_id])
  user   UserAccount? @relation(fields: [user_id], references: [user_id])

  @@map("control_command")
}

model UserAccount {
  user_id       Int       @id @default(autoincrement())
  username      String    @unique @db.VarChar(255)
  password_hash String    @db.VarChar(255)
  role          String?   @db.VarChar(255)
  last_login    DateTime?

  // Relations
  userSites       UserSite[]
  controlCommands ControlCommand[]

  @@map("user_account")
}

model UserSite {
  user_site_id Int     @id @default(autoincrement())
  user_id      Int?
  site_id      Int?
  access_level String? @db.VarChar(255)

  // Relations
  user UserAccount? @relation(fields: [user_id], references: [user_id])
  site Site?        @relation(fields: [site_id], references: [site_id])

  @@map("user_site")
}